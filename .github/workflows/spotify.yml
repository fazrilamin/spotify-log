name: Spotify Song Logger

on:
  schedule:
    - cron: "0 0 * * *" # Runs daily at midnight UTC
  workflow_dispatch:

jobs:
  update-log:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Fetch last played song
        run: |
          curl -s -X POST "https://accounts.spotify.com/api/token" \
            -H "Authorization: Basic $(echo -n '${{ secrets.SPOTIFY_CLIENT_ID }}:${{ secrets.SPOTIFY_CLIENT_SECRET }}' | base64)" \
            -d grant_type=refresh_token \
            -d refresh_token=${{ secrets.SPOTIFY_REFRESH_TOKEN }} > token.json
          
          ACCESS_TOKEN=$(jq -r '.access_token' token.json)

          curl -s -X GET "https://api.spotify.com/v1/me/player/recently-played?limit=1" \
            -H "Authorization: Bearer $ACCESS_TOKEN" > songs.json

          SONG_NAME=$(jq -r '.items[0].track.name' songs.json)
          ARTIST_NAME=$(jq -r '.items[0].track.artists[0].name' songs.json)

          echo "$(date): $SONG_NAME - $ARTIST_NAME" >> spotify-log.txt

      - name: Commit and push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add spotify-log.txt
          git commit -m "Updated song log"
          git push
